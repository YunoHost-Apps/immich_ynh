#:schema https://raw.githubusercontent.com/YunoHost/apps/master/schemas/manifest.v2.schema.json

packaging_format = 2

id = "immich"
name = "Immich"
description.en = "Photo and video backup solution directly from your mobile phone"
description.fr = "Sauvegarde de photos et de vidÃ©os directement depuis votre mobile"

version = "2.5.3~ynh1"

maintainers = ["ewilly"]

[upstream]
license = "AGPL-3.0-or-later"
website = "https://immich.app"
demo = "https://demo.immich.app"
admindoc = "https://github.com/immich-app/immich#getting-started"
userdoc = "https://github.com/immich-app/immich#getting-started"
code = "https://github.com/immich-app/immich"

[integration]
yunohost = ">= 12.1.39"
helpers_version = "2.1"
architectures = ["arm64", "amd64"]
multi_instance = false

ldap = false
sso = false

disk = "2G"
ram.build = "4G"
ram.runtime = "2G"

[install]
	[install.domain]
	type = "domain"

	[install.init_main_permission]
	type = "group"
	default = "visitors"

[resources]
	[resources.sources]

	[resources.sources.main]
	url = "https://github.com/immich-app/immich/archive/refs/tags/v2.5.3.tar.gz"
	sha256 = "1f744208f8175eaa7871ea024f2ae0379d804db5eafb4e3d6fde980e21dcdd19"

	autoupdate.strategy = "latest_github_release"

	[resources.sources.libheif]
	# Version from  https://github.com/immich-app/base-images/blob/main/server/sources/libheif.json
	url = "https://github.com/strukturag/libheif/releases/download/v1.21.2/libheif-1.21.2.tar.gz"
	sha256 = "75f530b7154bc93e7ecf846edfc0416bf5f490612de8c45983c36385aa742b42"

	autoupdate.strategy = "latest_github_release"
	autoupdate.asset = "^libheif-.*\\.tar\\.gz$"
	autoupdate.upstream = "https://github.com/strukturag/libheif"

    [resources.sources.libvips]
    # Version from https://github.com/immich-app/base-images/blob/main/server/sources/libvips.json
    url = "https://github.com/libvips/libvips/releases/download/v8.18.0/vips-8.18.0.tar.xz"
    sha256 = "b85ab92280c30d22f5c8fe2f68b809cddb7eaac437d8c33474475dac84ddc574"

    autoupdate.strategy = "latest_github_release"
    autoupdate.asset = "^vips-.*\\.tar\\.xz$"
    autoupdate.upstream = "https://github.com/libvips/libvips"

	[resources.system_user]

	[resources.install_dir]

	[resources.data_dir]

	[resources.permissions]
	main.url = "/"
	api.url = "/api"
	api.allowed = "visitors"
	api.show_tile = false
	api.protected = true

	[resources.ports]
	main.default = 2283
	machinelearning.default = 3003

	[resources.apt]
	packages = [
		"curl",
		"postgresql",
		"redis-server",
		"python3",
		"python3-dev",
		"libssl-dev",
		"libffi-dev",
		"uuid-runtime",
		"autoconf",
		"build-essential",
		"unzip",
		"jq",
		"perl",
		"libnet-ssleay-perl",
		"libio-socket-ssl-perl",
		"libcapture-tiny-perl",
		"libfile-which-perl",
		"libfile-chdir-perl",
		"libpkgconfig-perl",
		"libffi-checklib-perl",
		"libtest-warnings-perl",
		"libtest-fatal-perl",
		"libtest-needs-perl",
		"libtest2-suite-perl",
		"libsort-versions-perl",
		"libpath-tiny-perl",
		"libtry-tiny-perl",
		"libterm-table-perl",
		"libany-uri-escape-perl",
		"libmojolicious-perl",
		"libfile-slurper-perl",
		"liblcms2-2",
		"wget",
		"yq",
		"ccache",
		"libgl1",
		"cmake",
		"meson",
		"ninja-build",
		"pkg-config",
		"libdav1d-dev",
		"libwebp-dev",
		"libaom-dev",
		"libde265-dev",
		"libexif-dev",
		"libexpat1-dev",
		"libglib2.0-dev",
		"libjpeg-dev",
		"libpng-dev",
		"libgif-dev",
		"libimagequant-dev",
		"libcgif-dev",
		"libraw-dev"
	]
	packages_from_raw_bash = """
	if [[ $YNH_DEBIAN_VERSION == "trixie" ]]; then
		echo "postgresql-17-pgvector";
	fi
	"""

	[resources.apt.extras.jellyfin-ffmpeg]
	repo = "deb https://repo.jellyfin.org/debian __YNH_DEBIAN_VERSION__ main"
	key = "https://repo.jellyfin.org/jellyfin_team.gpg.key"
	packages = [
		"jellyfin-ffmpeg7"
	]

	[resources.apt.extras.mise]
	repo = "deb https://mise.jdx.dev/deb stable main"
	key = "https://mise.jdx.dev/gpg-key.pub"
	packages = [
		"mise"
	]

	[resources.nodejs]
	version = "24"

	[resources.database]
	type = "postgresql"
